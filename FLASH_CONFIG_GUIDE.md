# Flash分区配置功能说明

## 功能概述

Flash分区配置页面用于管理eMMC Flash的分区配置。通过此页面，您可以：

1. 查看和编辑Flash分区信息
2. 修改分区大小、标签、文件、挂载点和类型
3. 启用或禁用分区
4. 自动生成并更新defconfig配置文件

## 使用方法

### 1. 打开Flash配置页面

在主窗口顶部的标签页中选择 "Flash分区配置" 标签。

### 2. 查看分区表格

左侧表格显示所有Flash分区的信息：

- **分区号**: 分区编号（2-9，分区1保留用于fip.bin）
- **启用**: 复选框，控制是否启用该分区（对应CONFIG_PARTITION_X=y）
- **标签**: 分区标签名称
- **大小(KB)**: 分区大小，以KB为单位
- **文件**: 关联的文件名
- **挂载点**: Linux挂载点路径
- **类型**: 文件系统类型（如ext4）

### 3. 编辑分区配置

#### 方法一：双击表格行
1. 双击任意分区行
2. 右侧配置面板会自动展开
3. 修改配置字段：
   - 标签：分区名称
   - 大小(KB)：输入数值（**仅支持KB单位，必须是64的倍数**）
   - 文件：关联文件名
   - 挂载点：Linux挂载路径
   - 类型：文件系统类型
4. 按回车键保存配置
5. 配置成功后会显示确认弹窗，展示更新后的配置信息

#### 方法二：使用搜索功能
1. 在右侧"分区搜索"框中输入分区标签
2. 按回车键快速定位并选中分区
3. 配置面板自动展开进行编辑

### 4. 启用/禁用分区

在表格的"启用"列中，勾选或取消勾选复选框。启用的分区会在导出时生成`CONFIG_PARTITION_X=y`配置项。

### 5. 添加新分区

1. 点击"添加分区"按钮
2. 系统会自动分配下一个可用的分区号
3. 新分区会以默认配置添加到表格中
4. 双击新分区行进行编辑

### 6. 删除分区

1. 选中要删除的分区行
2. 点击"删除分区"按钮
3. 确认删除操作

### 7. 重置配置

点击"重置配置"按钮可以恢复到默认分区配置。

### 8. 导出配置

#### 导出到defconfig文件

1. 确保已选择芯片类型和源代码路径
2. 点击"导出配置"按钮
3. 配置会**增量更新**到对应的defconfig文件（仅修改改动部分，保留其他内容）：
   ```
   build/boards/cv184x/[芯片型号]_wevb_0014a_emmc/[芯片型号]_wevb_0014a_emmc_defconfig
   ```
4. 系统会智能识别修改的配置项，只更新变化的行，不会重新生成整个配置段

生成的配置格式示例：
```bash
# Partition Configuration
#
CONFIG_FLASH_SIZE="32GB"
CONFIG_PARTITION_COUNT=9
# eMMC use partation 1 to store fip.bin so we started form partition 2
CONFIG_PARTITION_2=y
CONFIG_PARTITION_2_LABEL="2nd"
CONFIG_PARTITION_2_SIZE="3072"
CONFIG_PARTITION_2_FILE="yoc.bin"
CONFIG_PARTITION_2_MOUNTPOINT=""
CONFIG_PARTITION_2_TYPE=""

CONFIG_PARTITION_3=y
CONFIG_PARTITION_3_LABEL="BOOT"
CONFIG_PARTITION_3_SIZE="8192"
CONFIG_PARTITION_3_FILE="boot.emmc"
CONFIG_PARTITION_3_MOUNTPOINT=""
CONFIG_PARTITION_3_TYPE=""

...
```

#### 导出到JSON文件

1. 点击"导出配置"按钮（如果需要保存到自定义位置）
2. 选择保存路径和文件名
3. 配置会以JSON格式导出，便于版本控制和分享

### 9. 导入配置

1. 点击"导入配置"按钮
2. 选择之前导出的JSON配置文件
3. 配置会被加载到表格中

### 10. 查看分区映射

右侧"分区映射"文本框实时显示：
- Flash总大小（以KB为单位）
- 分区数量
- 每个分区的详细信息（启用状态、标签、大小(KB)、文件、挂载点、类型）

**注意**: 所有大小统一以KB为单位显示，便于对比和查看。

## 分区大小验证机制

### 验证规则

所有分区大小必须满足以下条件：
1. **单位固定**: 只能使用KB作为单位
2. **64倍数**: 大小必须是64的倍数
3. **非负数**: 大小必须大于或等于0

### 验证流程

当您在配置面板中修改分区大小并按回车键时：

1. **验证通过**:
   - 显示配置成功弹窗
   - 弹窗显示更新后的所有配置信息：
     - 标签
     - 大小（KB）
     - 文件
     - 挂载点
     - 类型
   - 更新表格和分区映射视图

2. **验证失败（不是64的倍数）**:
   - 显示错误提示弹窗
   - 提示信息包含：
     - 当前输入的值
     - 建议值1（向下取整到64的倍数）
     - 建议值2（向上取整到64的倍数）
   - 自动恢复到修改前的值
   - 不更新任何配置

### 示例

**场景1: 输入有效值**
```
输入: 3072
结果: ✓ 验证通过（3072是64的倍数）
显示: "配置成功" 弹窗，展示完整配置信息
```

**场景2: 输入无效值**
```
输入: 3000
结果: ✗ 验证失败（3000不是64的倍数）
提示: 
  当前输入: 3000 KB
  建议值: 2944 KB 或 3008 KB
操作: 自动恢复到原值
```

## 默认分区配置

系统预置了以下默认分区：

| 分区号 | 标签 | 大小 | 文件 | 挂载点 | 类型 | 启用 |
|--------|------|------|------|--------|------|------|
| 2 | 2nd | 3072 KB | yoc.bin | - | - | ✓ |
| 3 | BOOT | 8192 KB | boot.emmc | - | - | ✓ |
| 4 | MISC | 512 KB | logo.jpg | - | - | ✓ |
| 5 | ENV | 128 KB | - | - | - | ✓ |
| 6 | ROOTFS | 70656 KB | rootfs.emmc | - | - | ✓ |
| 7 | SYSTEM | 40960 KB | system.emmc | /mnt/system | ext4 | ✗ |
| 8 | CFG | 15240 KB | cfg.emmc | mnt/cfg | ext4 | ✗ |
| 9 | DATA | 3145728 KB | data.emmc | mnt/data | ext4 | ✗ |

## 注意事项

1. **分区1保留**: eMMC的分区1用于存储fip.bin，不应被修改
2. **大小单位限制**: 
   - 分区大小**仅支持KB单位输入**
   - 大小**必须是64的倍数**
   - 如果输入的值不符合要求，系统会显示错误提示并提供建议值（向下取整和向上取整的64倍数）
3. **启用状态**: 只有启用的分区才会在defconfig中生成`CONFIG_PARTITION_X=y`配置
4. **路径选择**: 使用前请确保已在启动时选择正确的源代码路径
5. **芯片类型**: 不同芯片型号的defconfig文件路径不同，请确保选择正确的芯片型号
6. **增量更新**: 导出配置时采用增量更新机制，只修改变化的配置项，保留文件中的其他内容和注释
7. **配置确认**: 每次成功修改配置后都会显示确认弹窗，展示更新的详细信息

## 工作流程建议

1. 启动应用程序，选择源代码路径
2. 在主界面选择芯片型号
3. 切换到"Flash分区配置"标签页
4. 根据需求编辑分区配置：
   - 双击分区行打开配置面板
   - 输入KB单位的大小值（确保是64的倍数）
   - 修改其他字段（标签、文件、挂载点、类型）
   - 按回车键保存，查看确认弹窗
5. 勾选需要启用的分区
6. 点击"导出配置"将配置增量更新到defconfig文件
7. 系统会显示导出成功的提示，包含defconfig文件的完整路径

**提示**: 增量更新机制会保留原有文件的其他配置和注释，无需手动备份。但首次使用建议备份原始文件。

## 技术实现

- **UI框架**: Qt6 Widgets
- **配置存储**: QMap<int, FlashPartition>
- **文件格式**: Linux defconfig格式
- **导入导出**: JSON格式支持
- **实时更新**: 配置更改时表格和映射视图自动更新

## 常见问题与故障排除

### Q1: 为什么输入的分区大小被拒绝？

**A**: 分区大小必须是64的倍数。系统会显示错误提示并提供两个建议值：
- 向下取整的64倍数
- 向上取整的64倍数

选择其中一个建议值重新输入即可。

### Q2: 如何知道配置是否保存成功？

**A**: 每次成功修改配置后，系统会显示"配置成功"弹窗，展示更新后的完整配置信息。

### Q3: 导出配置会覆盖整个defconfig文件吗？

**A**: 不会。v1.1版本采用增量更新机制，只修改变化的配置行，保留文件中的其他内容和注释。

例如：只修改分区2的大小从3072改为3008，则只更新这一行：
```bash
CONFIG_PARTITION_2_SIZE="3008"
```

### Q4: 为什么Flash大小和分区大小都是KB单位？

**A**: 统一使用KB单位是为了：
1. 方便对比不同分区的大小
2. 与defconfig文件中的配置值保持一致
3. 避免单位转换带来的混淆

### Q5: 可以使用MB或GB单位输入吗？

**A**: 从v1.1版本开始，只支持KB单位输入。这样可以确保精确控制分区大小，避免单位转换错误。

### Q6: 如何恢复默认配置？

**A**: 点击"重置配置"按钮，系统会恢复到预置的8个默认分区配置。

### Q7: 导出失败提示"Defconfig文件不存在"怎么办？

**A**: 请检查：
1. 是否正确选择了源代码路径
2. 是否正确选择了芯片型号
3. defconfig文件路径是否正确：`build/boards/cv184x/[芯片型号]_wevb_0014a_emmc/[芯片型号]_wevb_0014a_emmc_defconfig`

### Q8: 修改配置后如何应用到实际编译？

**A**: 
1. 在Flash配置页面点击"导出配置"
2. 配置会更新到defconfig文件
3. 使用构建系统重新编译即可应用新的分区配置

## 相关文件

- `src/flashconfig.h` - Flash配置头文件
- `src/flashconfig.cpp` - Flash配置实现
- `src/mainwindow.cpp` - 主窗口集成
- `CMakeLists.txt` - 构建配置

## 版本信息

- 创建日期: 2025年11月3日
- 最后更新: 2025年11月3日
- 功能版本: 1.1
- 兼容芯片: cv184x系列（cv1801c/h, cv1811c/h, cv1842cp/hp）

### 版本历史

**v1.1 (2025-11-03)**
- ✨ 新增：大小输入限制为KB单位，隐藏MB/GB单位选择
- ✨ 新增：大小必须是64的倍数验证机制
- ✨ 新增：配置成功后显示确认弹窗
- ✨ 新增：增量更新defconfig机制（仅修改变化项）
- 🔧 优化：Flash总大小和分区大小统一显示为KB单位
- 🔧 优化：验证失败时自动恢复旧值并提供建议值

**v1.0 (2025-11-03)**
- 🎉 初始版本发布
- ✅ 支持Flash分区表格查看和编辑
- ✅ 支持defconfig文件导出
- ✅ 支持JSON配置导入导出
- ✅ 支持分区搜索功能
- ✅ 支持分区映射可视化
