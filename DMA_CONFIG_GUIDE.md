# CviCubeMX DMA配置指南

## 概述

本指南详细说明如何在CviCubeMX中配置系统DMA（SYSDMA），包括DMA通道映射、外设配置和设备树生成等功能。

## 目录

- [DMA功能特性](#dma功能特性)
- [DMA配置界面](#dma配置界面)
- [DMA通道映射](#dma通道映射)
- [配置步骤](#配置步骤)
- [设备树生成](#设备树生成)
- [常见问题](#常见问题)

## DMA功能特性

### 1. 智能DMA启用控制
- **自动检测**：根据芯片型号自动读取对应的defconfig文件
- **配置项检查**：检查 `CONFIG_DMADEVICES` 和 `CONFIG_DW_DMAC_CVITEK` 是否为 `y`
- **动态更新**：切换芯片型号时自动更新DMA启用状态

### 2. 8通道DMA配置
- 支持8个独立的DMA通道配置（通道0-7）
- 每个通道可独立配置目标外设
- 支持43种预定义的DMA通道类型

### 3. 智能配置生成
- **单通道模式**：为单独配置的外设生成rx或tx配置
- **双通道模式**：为同一外设的rx+tx通道组合生成txrx配置
- **智能清理**：仅清除实际变更的外设DMA配置

## DMA配置界面

### 外设配置面板
1. 在左侧外设配置面板中找到 **SYSDMA** 项
2. 勾选SYSDMA复选框启用DMA功能
3. 点击SYSDMA项进入详细配置

### DMA通道配置对话框
- **8个通道下拉框**：分别对应DMA通道0-7
- **应用按钮**：保存当前配置到设备树
- **43种DMA类型**：包括各种外设的接收(RX)和发送(TX)通道

## DMA通道映射

### 支持的DMA通道类型

#### I2S系列
- `I2S0_RX` (通道0) - I2S0接收
- `I2S0_TX` (通道1) - I2S0发送  
- `I2S1_RX` (通道2) - I2S1接收
- `I2S1_TX` (通道3) - I2S1发送
- `I2S2_RX` (通道4) - I2S2接收
- `I2S2_TX` (通道5) - I2S2发送
- `I2S3_RX` (通道6) - I2S3接收
- `I2S3_TX` (通道7) - I2S3发送

#### UART系列
- `UART0_RX` (通道8) - UART0接收
- `UART0_TX` (通道9) - UART0发送
- `UART1_RX` (通道10) - UART1接收
- `UART1_TX` (通道11) - UART1发送
- `UART2_RX` (通道12) - UART2接收
- `UART2_TX` (通道13) - UART2发送
- `UART3_RX` (通道14) - UART3接收
- `UART3_TX` (通道15) - UART3发送
- `UART4_RX` (通道16) - UART4接收
- `UART4_TX` (通道17) - UART4发送

#### SPI系列
- `SPI0_RX` (通道18) - SPI0接收
- `SPI0_TX` (通道19) - SPI0发送
- `SPI1_RX` (通道20) - SPI1接收
- `SPI1_TX` (通道21) - SPI1发送
- `SPI2_RX` (通道22) - SPI2接收
- `SPI2_TX` (通道23) - SPI2发送
- `SPI3_RX` (通道24) - SPI3接收
- `SPI3_TX` (通道25) - SPI3发送

#### I2C系列
- `I2C0_RX` (通道26) - I2C0接收
- `I2C0_TX` (通道27) - I2C0发送
- `I2C1_RX` (通道28) - I2C1接收
- `I2C1_TX` (通道29) - I2C1发送
- `I2C2_RX` (通道30) - I2C2接收
- `I2C2_TX` (通道31) - I2C2发送
- `I2C3_RX` (通道32) - I2C3接收
- `I2C3_TX` (通道33) - I2C3发送
- `I2C4_RX` (通道34) - I2C4接收
- `I2C4_TX` (通道35) - I2C4发送

#### ADC系列
- `SARADC` (通道36) - SAR ADC
- `RTCSYS_SARADC` (通道37) - RTC系统SAR ADC

#### 其他外设
- `SPI_NAND` (通道38) - SPI NAND闪存
- `SPI_NOR` (通道39) - SPI NOR闪存
- `TDMA_RX` (通道40) - TDMA接收
- `TDMA_TX` (通道41) - TDMA发送
- `AUDSRC` (通道42) - 音频源

## 配置步骤

### 1. 启用SYSDMA
1. 选择目标芯片型号
2. 确认左侧外设面板中SYSDMA已勾选
3. 如未勾选，检查对应芯片的defconfig文件

### 2. 配置DMA通道
1. 点击SYSDMA项打开配置对话框
2. 为需要的通道选择对应的DMA类型
3. 点击"应用"按钮保存配置

### 3. 生成设备树
1. 完成所有配置后点击"生成代码"
2. 系统会自动更新设备树文件
3. 查看生成的DMA节点配置

## 设备树生成

### 配置格式

#### 单通道配置示例
```dts
&i2s0 {
    status = "okay";
    dmas = <&dmac 0>;
    dma-names = "rx";
};
```

#### 双通道配置示例  
```dts
&i2s1 {
    status = "okay";
    dmas = <&dmac 2>, <&dmac 3>;
    dma-names = "rx", "tx";
};
```

### 智能配置逻辑
- **非相邻通道支持**：支持通道0和通道7同时指向同一外设
- **自动类型检测**：根据通道编号自动判断RX/TX类型
- **智能清理**：只清除实际发生变更的外设配置

### 生成的文件位置
```
build/boards/default/dts/cv184x/cv184x_base.dtsi
```

## 常见问题

### Q1: SYSDMA复选框无法勾选
**A**: 检查对应芯片的defconfig文件中是否包含以下配置：
```bash
CONFIG_DMADEVICES=y
CONFIG_DW_DMAC_CVITEK=y
```

### Q2: 切换芯片后SYSDMA状态变化
**A**: 这是正常行为，系统会根据不同芯片的defconfig文件自动调整SYSDMA启用状态。

### Q3: 配置了通道但设备树中没有生成
**A**: 请确认：
1. 点击了"应用"按钮保存配置
2. 最后点击了"生成代码"按钮
3. 检查控制台输出是否有错误信息

### Q4: 同一外设的RX和TX通道应该如何配置
**A**: 
- 可以配置在任意两个通道上，不需要相邻
- 例如：通道0=I2S1_RX，通道7=I2S1_TX
- 系统会自动生成合并的txrx配置

### Q5: 如何清除某个外设的DMA配置
**A**: 
1. 将该外设对应的所有DMA通道设置为"未配置"
2. 点击"应用"按钮
3. 系统会自动清除该外设的DMA配置

## 技术细节

### defconfig文件路径格式
```
build/boards/cv184x/{芯片型号}_wevb_0014a_emmc/linux/cvitek_{芯片型号}_wevb_0014a_emmc_defconfig
```

### 支持的芯片型号
- cv1801c, cv1801h
- cv1811c, cv1811h  
- cv1842cp, cv1842hp

### DMA配置存储
- **UI状态**：存储在应用程序内存中
- **设备树配置**：保存在cv184x_base.dtsi文件中
- **内核配置**：保存在对应的defconfig文件中

## 更新日志

### v1.0.0
- 初始DMA配置功能
- 支持8通道DMA配置
- 基础设备树生成

### v1.1.0
- 添加智能配置清理功能
- 支持非相邻通道配对
- 改进defconfig文件读取逻辑

### v1.2.0 (当前版本)
- 基于芯片型号的动态DMA启用检测
- 自动更新UI状态
- 优化通道映射逻辑

## 支持与反馈

如遇到问题或有改进建议，请通过以下方式联系：
- 项目仓库：CviCubeMX
- 开发者：JansonXIE

---

*最后更新：2025年9月29日*