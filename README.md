# CviCubeMX - 芯片引脚配置工具

CviCubeMX是一个基于Qt C++开发的芯片引脚配置工具，用于CV系列芯片的引脚功能配置和代码生成。

## 功能特性

### 1. 芯片选型
- 支持多种CV系列芯片：cv1801c、cv1801h、cv1811c、cv1811h、cv1842cp、cv1842hp
- 自动识别芯片封装类型（QFN/BGA）

### 2. 引脚配置
- **QFN封装** (cv1801c、cv1811c、cv1842cp)：方形引脚按钮，分布在芯片外围四周
  - 引脚编号：从左侧第1号引脚开始，逆时针排列（左侧→底部→右侧→顶部）
  - cv1801c/cv1801h: 64引脚 (每边16个)
  - cv1811c/cv1811h: 88引脚 (每边22个)  
  - cv1842cp: 88引脚 (每边22个)
- **BGA封装** (cv1801h、cv1811h、cv1842hp)：圆形引脚按钮，分布在芯片内部网格
  - 引脚编号：行号A-R（跳过I），列号1-15（如A1, B2, R15）
  - cv1801h: 64引脚 (8x8网格)
  - cv1811h: 88引脚 (自适应网格)
  - cv1842hp: 225引脚 (15x15网格)
- 支持多种引脚功能：GPIO、ADC、I2C、UART、SPI、PWM、Timer

### 3. 外设配置 🆕
- **设备树配置**：自动读取和修改 `cv184x_base.dtsi` 设备树文件
- **外设状态管理**：可配置外设为 "okay" 或 "disabled" 状态
- **时钟配置**：支持修改外设时钟名称和频率
- **支持的外设**：PWM, I2C, SPI, UART, GPIO, ADC
- **实时同步**：配置修改立即保存到设备树文件

### 4. 代码生成
- 自动生成`cvi_board_init.c`文件
- 包含完整的引脚复用配置代码
- 生成标准的PINMUX宏调用

## 系统要求

- Windows 10/11
- Qt 6.x
- CMake 3.16+
- C++17兼容的编译器

## 构建说明

### 使用CMake构建

**方法1：使用批处理脚本（推荐）**
```bash
# Windows
.\build.bat

# Linux
chmod +x build.sh
./build.sh
```

**方法2：手动构建**
```bash
# 清理之前的构建
rm -rf build

# 配置项目（请根据您的Qt安装路径调整CMAKE_PREFIX_PATH）
cmake -S . -B build -D CMAKE_BUILD_TYPE=Release -D CMAKE_PREFIX_PATH=C:/Qt/6.9.1/msvc2022_64 -D CMAKE_CXX_STANDARD=17 -D CMAKE_CXX_STANDARD_REQUIRED=ON -D CMAKE_CXX_FLAGS="/Zc:__cplusplus"

# 编译项目
cmake --build build --config Release

# 打开正确的 Qt 命令行终端
# 这一步至关重要。你需要使用一个已经配置好 Qt 环境变量的终端。
# 点击 Windows 的“开始”菜单。
# 在所有应用中找到你的 Qt 安装文件夹。
# 点击并打开 "Qt 6.9.1 (MSVC 2022 64-bit)"。这会启动一个预先配置好的命令行窗口。
# 运行 windeployqt 命令
windeployqt "C:\Users\jansonxie\Desktop\CviCubeMX\build\bin\Release\CviCubeMX.exe"
```

### 使用Qt Creator
1. 打开Qt Creator
2. 选择"打开项目"
3. 选择`CMakeLists.txt`文件
4. 配置项目并构建

## 使用说明

### 1. 启动应用
运行生成的可执行文件`CviCubeMX.exe`

### 2. 选择芯片
1. 在"芯片选型"下拉框中选择目标芯片型号
2. 点击"开始项目"按钮

### 3. 配置引脚
1. 在芯片视图中点击引脚按钮
2. 从弹出菜单中选择引脚功能
3. 不同功能的引脚会显示不同颜色：
   - 灰色：GPIO
   - 红色：ADC
   - 蓝色：I2C
   - 绿色：UART
   - 橙色：SPI
   - 紫色：PWM
   - 橘色：Timer

### 4. 配置外设 🆕
1. 在左侧配置面板中展开"外设"节点
2. 点击所需的外设类型（PWM, I2C, SPI, UART, GPIO, ADC）
3. 从弹出菜单选择具体的外设实例（如PWM0, I2C1等）
4. 在配置对话框中设置：
   - **外设选择**：选择要配置的具体外设
   - **状态**：选择 "okay"（启用）或 "disabled"（禁用）
   - **时钟名称**：查看或修改时钟名称
   - **时钟频率**：设置时钟频率（1KHz - 500MHz）
5. 点击"应用"保存配置到设备树文件

### 5. 生成代码
1. 配置完成后点击"生成代码"按钮
2. 选择保存位置
3. 生成的代码文件包含完整的引脚配置

## 项目结构

```
CviCubeMX/
├── src/                    # 源代码文件
│   ├── main.cpp           # 主程序入口
│   ├── mainwindow.cpp     # 主窗口实现
│   ├── chipconfig.cpp     # 芯片配置类
│   ├── pinwidget.cpp      # 引脚部件类
│   └── codegenerator.cpp  # 代码生成器
├── include/               # 头文件
│   ├── cvi_board_init.h   # 板级初始化头文件
│   └── pinmux.h          # 引脚复用定义
├── resources/             # 资源文件
│   └── style.qss         # 样式表
├── CMakeLists.txt        # CMake构建文件
├── CHIP_SPECS.md         # 芯片规格说明
├── QUICKSTART.md         # 快速开始指南
└── README.md             # 说明文档
```

## 生成代码示例

**QFN封装芯片(cv1801c)的代码示例：**
```c
/**
 * @file cvi_board_init.c
 * @brief Board initialization file generated by CviCubeMX
 * @author CviCubeMX Tool
 * @date 2025-07-13 12:00:00
 */

#include "cvi_board_init.h"
#include "pinmux.h"

/**
 * @brief Initialize board pin multiplexing
 * @note Generated for chip: cv1801c
 */
void cvi_board_init(void)
{
    // Pin configuration for cv1801c
    // Package type: QFN (Quad Flat No-leads)

    // I2C pins configuration
    PINMUX(GPIOA11, IIC0_SDA);  // Pin 12
    PINMUX(GPIOA12, IIC0_SCL);  // Pin 13

    // UART pins configuration
    PINMUX(GPIOA13, UART0_TX);  // Pin 14
    PINMUX(GPIOA14, UART0_RX);  // Pin 15
}
```

**BGA封装芯片(cv1842hp)的代码示例：**
```c
void cvi_board_init(void)
{
    // Pin configuration for cv1842hp
    // Package type: BGA (Ball Grid Array)

    // I2C pins configuration
    PINMUX(GPIOA0, IIC0_SDA);   // Pin A1
    PINMUX(GPIOA1, IIC0_SCL);   // Pin A2

    // UART pins configuration
    PINMUX(GPIOA2, UART0_TX);   // Pin A3
    PINMUX(GPIOA3, UART0_RX);   // Pin A4
}
```

## 部署和运行

### Windows部署

构建完成后，您需要确保Qt运行时库可用。有以下几种方法：

**方法1：使用windeployqt（推荐）**
```bash
# 在Qt安装目录的bin文件夹中找到windeployqt.exe
# 例如：C:\Qt\6.9.1\msvc2022_64\bin\windeployqt.exe

# 部署应用程序
C:\Qt\6.9.1\msvc2022_64\bin\windeployqt.exe build\bin\CviCubeMX.exe

# 运行应用程序
.\build\bin\CviCubeMX.exe
```

**方法2：添加Qt到系统PATH**
```bash
# 将Qt的bin目录添加到系统PATH环境变量
# 例如：C:\Qt\6.9.1\msvc2022_64\bin
```

**方法3：手动复制DLL文件**
将以下DLL文件从Qt安装目录复制到exe同目录：
- Qt6Core.dll
- Qt6Widgets.dll
- Qt6Gui.dll
- 以及其他依赖的DLL文件

### Linux部署

```bash
# 确保Qt6已安装
sudo apt install qt6-base-dev qt6-tools-dev cmake

# 设置环境变量
export LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu/qt6:$LD_LIBRARY_PATH

# 运行应用程序
./build/bin/CviCubeMX
```

## 故障排除

### 常见问题和解决方案

**1. "找不到Qt6Widgets.dll"错误**
- **原因**: Qt运行时库不在系统PATH中
- **解决方案**: 
  - 使用windeployqt工具部署应用程序
  - 或将Qt的bin目录添加到系统PATH
  - 或手动复制必要的DLL文件

**2. CMake配置失败**
- **原因**: 找不到Qt6或CMake版本过低
- **解决方案**: 
  - 确认Qt6正确安装
  - 检查CMAKE_PREFIX_PATH是否指向正确的Qt安装目录
  - 升级CMake到3.16或更高版本

**3. 编译错误**
- **原因**: 编译器不支持C++17或Qt版本不兼容
- **解决方案**: 
  - 确认使用支持C++17的编译器
  - 检查Qt版本是否为6.x
  - 确认编译器与Qt版本匹配

**4. 运行时崩溃**
- **原因**: 缺少必要的运行时库或插件
- **解决方案**: 
  - 使用windeployqt完整部署
  - 检查是否缺少Visual C++运行时库
  - 确认所有Qt插件已正确部署

### 创建便携版本

要创建可在其他计算机上运行的便携版本：

```bash
# 1. 构建Release版本
cmake --build build --config Release

# 2. 创建部署目录
mkdir CviCubeMX_Portable
cp build/bin/CviCubeMX.exe CviCubeMX_Portable/

# 3. 使用windeployqt部署
C:\Qt\6.9.1\msvc2022_64\bin\windeployqt.exe CviCubeMX_Portable\CviCubeMX.exe

# 4. 复制Visual C++运行时库（如果需要）
# 5. 测试在其他计算机上运行
```

### 获取技术支持

如果遇到其他问题，请：
1. 检查Qt和编译器版本兼容性
2. 查看编译和运行时错误日志
3. 确认系统环境变量配置
4. 参考Qt官方文档进行故障排除

## 许可证

本项目采用MIT许可证。详情请参见LICENSE文件。

## 联系方式

如有问题或建议，请联系项目维护者。
